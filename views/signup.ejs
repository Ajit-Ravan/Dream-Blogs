<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Signup Page</title>
    <%- include("./partials/head") %>
  </head>
  <body>
    <%- include('./partials/nav') %>
    <div class="container mt-4">
      <form action="/user/signup" method="post">
        <div class="mb-3">
          <label for="firstName" class="form-label">Full Name</label>
          <input
            type="text"
            class="form-control"
            id="firstName"
            name="firstName"
            required
          />
        </div>

        <div class="mb-3">
          <label for="email" class="form-label">Email address</label>
          <input
            type="email"
            class="form-control"
            id="email"
            name="email"
            required
          />
        </div>

        <div class="mb-3">
          <label for="password" class="form-label">Password</label>
          <input
            type="password"
            class="form-control"
            id="password"
            name="password"
            required
          />
        </div>

        <div class="mb-3">
          <h2>Select Location</h2>

          <!-- Country Dropdown -->
          <label for="country">Country:</label>
          <select id="country" name="country" onchange="loadStates()">
            <option value="">Select Country</option>
            <% countries.forEach(country => { %>
            <option value="<%= country.short_name %>">
              <%= country.name %>
            </option>
            <!-- Assuming country.short_name is the countryCode -->
            <% }) %>
          </select>

          <!-- State Dropdown -->
          <label for="state" class="mt-2">State:</label>
          <select id="state" name="state" onchange="loadCities()">
            <option value="">Select State</option>
            <% states.forEach(state => { %>
            <option value="<%= state._id %>"><%= state.name %></option>
            <% }) %>
          </select>

          <!-- City Dropdown -->
          <label for="city" class="mt-2">City:</label>
          <select id="city" name="city" class="form-select" required disabled>
            <option value="">Select City</option>
          </select>
        </div>

        <button type="submit" class="btn btn-primary mt-3">Submit</button>
      </form>
    </div>

    <%- include('./partials/scripts') %>

    <script>
      // DOM Elements
      const countrySelect = document.getElementById("country");
      const stateSelect = document.getElementById("state");
      const citySelect = document.getElementById("city");

      // Fetch and populate countries
      fetch("/get-countries")
        .then((response) => response.json())
        .then((data) => {
          data.data.forEach((country) => {
            const option = document.createElement("option");
            option.value = country.short_name; // Assuming country.short_name is the countryCode
            option.textContent = country.name;
            countrySelect.appendChild(option);
          });
        })
        .catch((err) => console.error("Error fetching countries:", err));

      // Event listener for country change
      countrySelect.addEventListener("change", function () {
        loadStates(); // Call the loadStates function on country change
      });

      // Function to load states based on selected country
      function loadStates() {
        const countryCode = countrySelect.value; // Assuming the value is the countryCode
        stateSelect.innerHTML = '<option value="">Select State</option>';
        citySelect.innerHTML = '<option value="">Select City</option>';
        stateSelect.disabled = true;
        citySelect.disabled = true;

        console.log("Fetching states for country code:", countryCode);
        if (countryCode) {
        }
        fetch(`/get-states?countryCode=${countryCode}`) // Make sure you pass the correct countryCode
          .then((response) => response.json())
          .then((states) => {
            if (states.success) {
              states.data.forEach((state) => {
                const option = document.createElement("option");
                option.value = state._id;
                option.textContent = state.name;
                stateSelect.appendChild(option);
              });
              stateSelect.disabled = false; // Enable state dropdown
            } else {
              console.error("Failed to fetch states:", states.msg);
            }
          })
          .catch((err) => console.error("Error fetching states:", err));
      }

      // Event listener for state change
      stateSelect.addEventListener("change", function () {
        loadCities(); // Call the loadCities function on state change
      });

      // Function to load cities based on selected state
      function loadCities() {
        const stateCode = stateSelect.value; // Assuming the value is the stateCode
        citySelect.innerHTML = '<option value="">Select City</option>';
        citySelect.disabled = true;

        if (stateCode) {
          fetch(`/get-cities/${stateCode}`)
            .then((response) => response.json())
            .then((cities) => {
              cities.data.forEach((city) => {
                const option = document.createElement("option");
                option.value = city._id;
                option.textContent = city.name;
                citySelect.appendChild(option);
              });
              citySelect.disabled = false; // Enable city dropdown
            })
            .catch((err) => console.error("Error fetching cities:", err));
        }
      }
    </script>
  </body>
</html>
